{
  "hash": "ae593b9d35ef7c7559f4a134a9e3d0c2",
  "result": {
    "markdown": "---\ndescription: R data.table\ntitle: \"R lib: data.table\"\ncategories: [\"data.table\"]\ntags: [\"R\", \"data.table\", \"datagrapling\",\"rolling joins\"]\ntoc: true\n---\n\n\n\n\n## Rolling join\n\n[source](https://www.gormanalysis.com/blog/r-data-table-rolling-joins/)\n\n### Problem\n\nsuppose you have a table of product sales and a table of commercials. You might want to associate each product sale with the most recent commercial that aired prior to the sale. In this case, you cannot do a basic join between the sales table and the commercials table because each sale was not tracked with a CommercialId attribute. Instead, you need to generate a mapping between sales and commercials based on logic involving their dates.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(data.table)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nsales <- data.table(\n  SaleId = c(\"S1\", \"S2\", \"S3\", \"S4\", \"S5\"),\n  SaleDate = as.Date(c(\"2014-2-20\", \"2014-5-1\", \"2014-6-15\", \"2014-7-1\", \"2014-12-31\"))\n)\n\ncommercials <- data.table(\n  CommercialId = c(\"C1\", \"C2\", \"C3\", \"C4\"),\n  CommercialDate = as.Date(c(\"2014-1-1\", \"2014-4-1\", \"2014-7-1\", \"2014-9-15\"))\n)\n\nsales[, RollDate := SaleDate]\ncommercials[, RollDate := CommercialDate]\n\nsetkey(sales, \"RollDate\")\nsetkey(commercials, \"RollDate\")\n```\n:::\n\n\ndata.table is associating each commercial with the most recent sale prior to the commercial date (and including the commercial date). In other words, the most recent sale prior to each commercial is said to \"roll forward\", and the SaleDate is mapped to the CommercialDate. Notice that sale S4 was the most recent sale prior to commercial C3 and C4, so S4 appears twice in the resultant table.\n\nTHIS HAVE NO logical SENSE. go forward\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsales[commercials, roll = TRUE]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   SaleId   SaleDate   RollDate CommercialId CommercialDate\n1:   <NA>       <NA> 2014-01-01           C1     2014-01-01\n2:     S1 2014-02-20 2014-04-01           C2     2014-04-01\n3:     S4 2014-07-01 2014-07-01           C3     2014-07-01\n4:     S4 2014-07-01 2014-09-15           C4     2014-09-15\n```\n:::\n:::\n\n\nHere data.table is associating each sale with the most recent commercial prior to (or including) the SaleDate. This is the solution to our originally stated problem.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncommercials[sales, roll = TRUE]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   CommercialId CommercialDate   RollDate SaleId   SaleDate\n1:           C1     2014-01-01 2014-02-20     S1 2014-02-20\n2:           C2     2014-04-01 2014-05-01     S2 2014-05-01\n3:           C2     2014-04-01 2014-06-15     S3 2014-06-15\n4:           C3     2014-07-01 2014-07-01     S4 2014-07-01\n5:           C4     2014-09-15 2014-12-31     S5 2014-12-31\n```\n:::\n:::\n\n\n![](https://www.gormanalysis.com/blog/r-data-table-rolling-joins_files/roll-2.gif)\n\ndata.table also supports backward rolling joins by setting roll = -Inf.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncommercials[sales, roll = -Inf]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   CommercialId CommercialDate   RollDate SaleId   SaleDate\n1:           C2     2014-04-01 2014-02-20     S1 2014-02-20\n2:           C3     2014-07-01 2014-05-01     S2 2014-05-01\n3:           C3     2014-07-01 2014-06-15     S3 2014-06-15\n4:           C3     2014-07-01 2014-07-01     S4 2014-07-01\n5:         <NA>           <NA> 2014-12-31     S5 2014-12-31\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}