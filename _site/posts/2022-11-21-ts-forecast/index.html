<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lukasz Rabalski blog - TS - forecast</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Lukasz Rabalski blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">Łukasz Rąbalski blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Rombix92?tab=repositories"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/%C5%82ukasz-r%C4%85balski-2892b8102/"><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">TS - forecast</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">Time Series</div>
                <div class="quarto-category">forecast</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#simple-case" id="toc-simple-case" class="nav-link active" data-scroll-target="#simple-case">simple case</a>
  <ul class="collapse">
  <li><a href="#general-exploration-of-ts" id="toc-general-exploration-of-ts" class="nav-link" data-scroll-target="#general-exploration-of-ts">general exploration of TS</a></li>
  <li><a href="#ar" id="toc-ar" class="nav-link" data-scroll-target="#ar">AR</a>
  <ul class="collapse">
  <li><a href="#selecting-parameter-of-ar" id="toc-selecting-parameter-of-ar" class="nav-link" data-scroll-target="#selecting-parameter-of-ar">selecting parameter of AR</a></li>
  <li><a href="#forecasting-1-time-step-ahead" id="toc-forecasting-1-time-step-ahead" class="nav-link" data-scroll-target="#forecasting-1-time-step-ahead">forecasting 1 time step ahead</a></li>
  <li><a href="#forecasting-many-steps-into-the-future" id="toc-forecasting-many-steps-into-the-future" class="nav-link" data-scroll-target="#forecasting-many-steps-into-the-future">Forecasting many steps into the future</a></li>
  <li><a href="#calculating-forecast-by-hand" id="toc-calculating-forecast-by-hand" class="nav-link" data-scroll-target="#calculating-forecast-by-hand">calculating forecast by hand</a></li>
  </ul></li>
  <li><a href="#ma-model" id="toc-ma-model" class="nav-link" data-scroll-target="#ma-model">MA model</a>
  <ul class="collapse">
  <li><a href="#selecting-parameter-of-ar-1" id="toc-selecting-parameter-of-ar-1" class="nav-link" data-scroll-target="#selecting-parameter-of-ar-1">selecting parameter of AR</a></li>
  <li><a href="#calculating-forecast-by-hand-1" id="toc-calculating-forecast-by-hand-1" class="nav-link" data-scroll-target="#calculating-forecast-by-hand-1">calculating forecast by hand</a></li>
  <li><a href="#forecasting-1-time-step-ahead-1" id="toc-forecasting-1-time-step-ahead-1" class="nav-link" data-scroll-target="#forecasting-1-time-step-ahead-1">forecasting 1 time step ahead</a></li>
  </ul></li>
  <li><a href="#more-complicated-case" id="toc-more-complicated-case" class="nav-link" data-scroll-target="#more-complicated-case">more complicated case</a>
  <ul class="collapse">
  <li><a href="#important-inferences" id="toc-important-inferences" class="nav-link" data-scroll-target="#important-inferences">Important Inferences</a></li>
  <li><a href="#solving-unstationary-issues" id="toc-solving-unstationary-issues" class="nav-link" data-scroll-target="#solving-unstationary-issues">Solving unstationary issues</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p><a href="https://archive.ics.uci.edu/ml/datasets/Daily+Demand+Forecasting+Orders">data set source</a></p>
<section id="simple-case" class="level1">
<h1>simple case</h1>
<section id="general-exploration-of-ts" class="level2">
<h2 class="anchored" data-anchor-id="general-exploration-of-ts">general exploration of TS</h2>
<p>First we plot the data in chronological order. Since we will model this as an AR process, we look to the PACF to set a cutoff on the order of the process</p>
<p>The database was collected during 60 days, this is a real database of a Brazilian company of large logistics. Twelve predictive attributes and a target that is the total of orders for daily.</p>
<p>Data looks stationary.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">plot</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>, <span class="at">type=</span><span class="st">'l'</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">abline</span>(<span class="at">reg=</span><span class="fu">lm</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span><span class="sc">~</span><span class="fu">index</span>(df)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</section>
<section id="ar" class="level2">
<h2 class="anchored" data-anchor-id="ar">AR</h2>
<p>As name suggest autoregression is regression made upon past values. The simplest autoregression model is known as AR(1): <span class="math inline">\(y_t=b_0+b_1*y_{t-1}+e_t\)</span> <span class="math inline">\(e_t\)</span> is changeable within time error with stable variance and mean = 0.</p>
<section id="selecting-parameter-of-ar" class="level3">
<h3 class="anchored" data-anchor-id="selecting-parameter-of-ar">selecting parameter of AR</h3>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">pacf</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>We can see that the value of the PACF crosses the 5% significance threshold at lag 3. This is consistent with the results from the ar() function available in R’s stats package. ar() automatically chooses the order of an autoregressive model if one is not specified:</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">ar</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>, <span class="at">method =</span> <span class="st">"mle"</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="do">## </span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="do">## Call:</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="do">## ar(x = df$Banking.orders..2., method = "mle")</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="do">## </span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="do">## Coefficients:</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="do">##       1        2        3  </span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="do">## -0.1360  -0.2014  -0.3175  </span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="do">## </span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="do">## Order selected 3  sigma^2 estimated as  1413820146</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Notice that the ar() function has also provided us with the coefficients for the model. We may, however, want to limit the coefficients. For example, looking at the PACF, we might wonder whether we really want to include a coefficient for the lag – 1 term or whether we should assign that term a mandatory coefficient of 0 given that its PACF value is well below the threshold used for significance. In this case, we can use the arima() function also from the stats package. Here, we demonstrate how to call the function to fit an AR(3), by setting the order parameter to c(3, 0, 0), where 3 refers to the order of the AR component</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>est <span class="ot">&lt;-</span> <span class="fu">arima</span>(<span class="at">x =</span> df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>,<span class="at">order =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb4-2"><a href="#cb4-2"></a>est</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="do">## </span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="do">## Call:</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="do">## arima(x = df$Banking.orders..2., order = c(3, 0, 0))</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="do">## </span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="do">## Coefficients:</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="do">##           ar1      ar2      ar3  intercept</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="do">##       -0.1358  -0.2013  -0.3176  79075.350</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="do">## s.e.   0.1299   0.1289   0.1296   2981.124</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="do">## </span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="do">## sigma^2 estimated as 1413818670:  log likelihood = -717.42,  aic = 1444.83</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To inject prior knowledge or opinion into our model, we can constraint a coefficient to be 0. For example, if we want to constrain the lag – 1 term to remain 0 in our model, we use the following call:</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>est<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">arima</span>(<span class="at">x =</span>  df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>,<span class="at">order =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">0</span>), </span>
<span id="cb5-2"><a href="#cb5-2"></a>               <span class="at">fixed =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We now inspect our model performance on our training data to assess the goodness of fit of our model to this data set. We can do this in two ways. First, we plot the ACF of the residuals (that, is the errors) to see if there is a pattern of self-correlation that our model does not cover.</p>
<p>Plotting the residuals is quite simple thanks to the output of the arima() function</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">acf</span>(est<span class="fl">.1</span><span class="sc">$</span>residuals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>est<span class="fl">.1</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="do">## </span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="do">## Call:</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="do">## arima(x = df$Banking.orders..2., order = c(3, 0, 0), fixed = c(0, NA, NA, NA))</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="do">## </span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="do">## Coefficients:</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="do">##       ar1      ar2      ar3  intercept</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="do">##         0  -0.1831  -0.3031  79190.705</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="do">## s.e.    0   0.1289   0.1298   3345.253</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="do">## </span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="do">## sigma^2 estimated as 1439790211:  log likelihood = -717.96,  aic = 1443.91</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>None of the values of the ACF cross the significance threshold.</p>
<p>We do not see a pattern of self-correlation here among the residuals (i.e., the error terms). If we had seen such a pattern, we would likely want to return to our original model and consider including additional terms to add complexity to account for the significant autocorrelation of the residuals.</p>
</section>
<section id="forecasting-1-time-step-ahead" class="level3">
<h3 class="anchored" data-anchor-id="forecasting-1-time-step-ahead">forecasting 1 time step ahead</h3>
<p>applying by hand</p>
<p>what’s important there are different type of parametrizations of ARIMA models</p>
<p>There are multiple (equivalent) parametrizations for ARIMA models. There’s the one you quote (sometimes called the ARMAX parametrization):</p>
<p><span class="math inline">\(y_t = \phi y_{t-1} + c + \epsilon_t\)</span></p>
<p>And the equivalent regression with ARMA errors parametrization:</p>
<p><span class="math inline">\((y_t - c') = \phi (y_{t-1} - c') + \epsilon_t\)</span></p>
<p>The forecast package uses the second parametrization.</p>
<p>The package author explains the difference between the two parametrizations and the rationale for choosing this one on his blog. Mostly, when adding other regressors (other than the constant), this version is easier to interpret. Since the function forecast::Arima allows for other regressors, it makes sense to treat them all in the same way.</p>
<p><a href="https://stats.stackexchange.com/questions/236633/r-arima-order1-0-0-forecast-not-giving-what-expected">url</a></p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="do">## intercept </span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="do">##  79190.71</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar1'</span>]</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="do">## ar1 </span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="do">##   0</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar2'</span>]</span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="do">##        ar2 </span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="do">## -0.1831204</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar3'</span>]</span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="do">##        ar3 </span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="do">## -0.3031044</span></span>
<span id="cb8-13"><a href="#cb8-13"></a></span>
<span id="cb8-14"><a href="#cb8-14"></a></span>
<span id="cb8-15"><a href="#cb8-15"></a>x<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>)</span>
<span id="cb8-16"><a href="#cb8-16"></a></span>
<span id="cb8-17"><a href="#cb8-17"></a>y_pred <span class="ot">=</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(<span class="fu">zoo</span>(x),</span>
<span id="cb8-18"><a href="#cb8-18"></a>               <span class="at">width=</span><span class="dv">3</span>,</span>
<span id="cb8-19"><a href="#cb8-19"></a>               <span class="at">FUN=</span><span class="cf">function</span>(w){</span>
<span id="cb8-20"><a href="#cb8-20"></a>                 est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>] <span class="sc">+</span> </span>
<span id="cb8-21"><a href="#cb8-21"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar1'</span>]<span class="sc">*</span>(w[<span class="dv">3</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb8-22"><a href="#cb8-22"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar2'</span>]<span class="sc">*</span>(w[<span class="dv">2</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb8-23"><a href="#cb8-23"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar3'</span>]<span class="sc">*</span>(w[<span class="dv">1</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) </span>
<span id="cb8-24"><a href="#cb8-24"></a>                 </span>
<span id="cb8-25"><a href="#cb8-25"></a>                </span>
<span id="cb8-26"><a href="#cb8-26"></a>                 },</span>
<span id="cb8-27"><a href="#cb8-27"></a>               <span class="at">partial =</span> <span class="cn">FALSE</span></span>
<span id="cb8-28"><a href="#cb8-28"></a>               )</span>
<span id="cb8-29"><a href="#cb8-29"></a></span>
<span id="cb8-30"><a href="#cb8-30"></a>y_pred <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">as.vector</span>(y_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">plot</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>, <span class="at">type =</span> <span class="st">'l'</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">lines</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>,<span class="at">h=</span><span class="dv">1</span>), <span class="at">col =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="dv">5</span>) <span class="do">## use the forecast package</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="fu">lines</span>(y_pred, <span class="at">col =</span> <span class="dv">6</span>, <span class="at">lwd =</span> <span class="dv">2</span>) <span class="do">## fitted by hand</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Now let’s think about the quality of the forecast. If we calculate the correlation between the predicted value and the actual value, we get 0.29. This is not bad in some contexts, but remember that sometimes differencing the data will remove what seemed like a strong relationship and replace it with one that is essentially random. This will be the case particularly if the data was not truly stationary when we fit it, so that an unidentified trend masquerades as good model performance when it is actually a trait of the data we should have addressed before modeling.</p>
<p>We can difference both the series and the predicted values to see whether the change from one time period to the next is well predicted by the model. Even after differenc‐ ing, our predictions and the data show similar patterns, suggesting our model is a meaningful one</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">cor</span>(y_pred[<span class="dv">1</span><span class="sc">:</span><span class="dv">60</span>],df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>[<span class="dv">1</span><span class="sc">:</span><span class="dv">60</span>])</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="do">## [1] 0.2998776</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="fu">cor</span>(<span class="fu">diff</span>(y_pred)[<span class="dv">1</span><span class="sc">:</span><span class="dv">59</span>],<span class="fu">diff</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">59</span>])</span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="do">## [1] 0.2187947</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="fu">plot</span>(<span class="fu">diff</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">59</span>],<span class="fu">diff</span>(y_pred)[<span class="dv">1</span><span class="sc">:</span><span class="dv">59</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</section>
<section id="forecasting-many-steps-into-the-future" class="level3">
<h3 class="anchored" data-anchor-id="forecasting-many-steps-into-the-future">Forecasting many steps into the future</h3>
<p>Looking back at the original plot of the forecast versus actual values, we see that the main difference between the forecast and the data is that the forecast is less variable than the data.</p>
<p>It may predict the direction of the future correctly, but not the scale of the change from one time period to another. This is not a problem per se but rather reflects the fact that forecasts are means of the predicted distributions and so necessarily will have lower variability than sampled data.</p>
<p>As you can see in the Figure below, the variance of the prediction decreases with increasing forward horizon. The reason for this—which highlights an important limitation of the model—is that the further forward in time we go, the less the actual data matters because the coefficients for input data look only at a finite previous set of time points (in this model, going back only to lag – 3; i.e., time – 3). The future prediction approaches the mean value of the series as the time horizon grows, and hence the variance of both the error term and of the forecast values shrinks to 0 as the forecast values tend toward the unconditional mean value.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">plot</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>, <span class="at">type =</span> <span class="st">'l'</span>)</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">lines</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>,<span class="at">h=</span><span class="dv">1</span>), <span class="at">col =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">6</span>) <span class="do">## use the forecast package</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="fu">lines</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>,<span class="at">h=</span><span class="dv">4</span>), <span class="at">col =</span> <span class="dv">4</span>, <span class="at">lwd =</span> <span class="dv">4</span>) <span class="do">## use the forecast package</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="fu">lines</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>,<span class="at">h=</span><span class="dv">7</span>), <span class="at">col =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="dv">2</span>) <span class="do">## use the forecast package</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
</section>
<section id="calculating-forecast-by-hand" class="level3">
<h3 class="anchored" data-anchor-id="calculating-forecast-by-hand">calculating forecast by hand</h3>
<p>Below how prediction for point 8 in time series in calculcated using window_width=3</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a></span>
<span id="cb12-2"><a href="#cb12-2"></a>ts<span class="ot">&lt;-</span>df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span></span>
<span id="cb12-3"><a href="#cb12-3"></a></span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a>y_hat_6_window_1 <span class="ot">=</span> est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>] <span class="sc">+</span> </span>
<span id="cb12-6"><a href="#cb12-6"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar1'</span>]<span class="sc">*</span>(ts[<span class="dv">5</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb12-7"><a href="#cb12-7"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar2'</span>]<span class="sc">*</span>(ts[<span class="dv">4</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb12-8"><a href="#cb12-8"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar3'</span>]<span class="sc">*</span>(ts[<span class="dv">3</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) </span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a>y_hat_7_window_2 <span class="ot">=</span> est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>] <span class="sc">+</span> </span>
<span id="cb12-11"><a href="#cb12-11"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar1'</span>]<span class="sc">*</span>(y_hat_6<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb12-12"><a href="#cb12-12"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar2'</span>]<span class="sc">*</span>(ts[<span class="dv">5</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb12-13"><a href="#cb12-13"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar3'</span>]<span class="sc">*</span>(ts[<span class="dv">4</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) </span>
<span id="cb12-14"><a href="#cb12-14"></a><span class="do">## Error in list2(...): object 'y_hat_6' not found</span></span>
<span id="cb12-15"><a href="#cb12-15"></a></span>
<span id="cb12-16"><a href="#cb12-16"></a>y_hat_8_window_3 <span class="ot">=</span> est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>] <span class="sc">+</span> </span>
<span id="cb12-17"><a href="#cb12-17"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar1'</span>]<span class="sc">*</span>(y_hat_7_window_2<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb12-18"><a href="#cb12-18"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar2'</span>]<span class="sc">*</span>(y_hat_6<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb12-19"><a href="#cb12-19"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar3'</span>]<span class="sc">*</span>(ts[<span class="dv">5</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) </span>
<span id="cb12-20"><a href="#cb12-20"></a><span class="do">## Error in list2(...): object 'y_hat_7_window_2' not found</span></span>
<span id="cb12-21"><a href="#cb12-21"></a></span>
<span id="cb12-22"><a href="#cb12-22"></a></span>
<span id="cb12-23"><a href="#cb12-23"></a><span class="fu">fitted</span>(est<span class="fl">.1</span>,<span class="at">h=</span><span class="dv">3</span>)[<span class="dv">8</span>] <span class="sc">==</span> y_hat_8_window_3</span>
<span id="cb12-24"><a href="#cb12-24"></a><span class="do">## Error in eval(expr, envir, enclos): object 'y_hat_8_window_3' not found</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Below show how variance is diminishing continously along broader and broader horizont width.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="do">## R</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="fu">var</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>, <span class="at">h =</span> <span class="dv">3</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="do">## [1] 174870141</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="fu">var</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>, <span class="at">h =</span> <span class="dv">5</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="do">## [1] 32323722</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="fu">var</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>, <span class="at">h =</span> <span class="dv">10</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="do">## [1] 1013396</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="fu">var</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>, <span class="at">h =</span> <span class="dv">20</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="do">## [1] 1176.689</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="ma-model" class="level2">
<h2 class="anchored" data-anchor-id="ma-model">MA model</h2>
<p>Do not confuse the MA model (moving average model) with a moving average. They are not the same thing.</p>
<p>MA models are by definition weakly stationary.</p>
<p>A moving average model can be expressed similarly to an autoregressive model except that the terms included in the linear equation refer to present and past error terms rather than present and past values of the process itself. So an MA model of order q is expressed as:</p>
<p><span class="math inline">\(yt = μ +e_t +θ_1 × e_{t-1} +θ_2 × e_{t-2}...+θ_q × e_{t-q}\)</span></p>
<ul>
<li><p>Economists talk about these error terms as “shocks” to the system,</p></li>
<li><p>while someone with an electrical engineering background could talk about this as a series of impulses and the model itself as a finite impulse response filter, meaning that the effects of any particular impulse remain only for a finite period of time.</p></li>
</ul>
<p>The wording is unimportant, but the concept of many independent events at different past times affecting the current value of the process, each making an individual contribution, is the main idea.</p>
<section id="selecting-parameter-of-ar-1" class="level3">
<h3 class="anchored" data-anchor-id="selecting-parameter-of-ar-1">selecting parameter of AR</h3>
<p>We see significant values at lags 3 and 9, so we fit an MA model with these lags.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">acf</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>ma.est <span class="ot">=</span> <span class="fu">arima</span>(<span class="at">x =</span> df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>,</span>
<span id="cb15-2"><a href="#cb15-2"></a>                     <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">9</span>),</span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="at">fixed =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="cn">NA</span>, <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="cn">NA</span>, <span class="cn">NA</span>))</span>
<span id="cb15-4"><a href="#cb15-4"></a>ma.est</span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="do">## </span></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="do">## Call:</span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="do">## arima(x = df$Banking.orders..2., order = c(0, 0, 9), fixed = c(0, 0, NA, rep(0, </span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="do">##     5), NA, NA))</span></span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="do">## </span></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="do">## Coefficients:</span></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="do">##       ma1  ma2      ma3  ma4  ma5  ma6  ma7  ma8      ma9  intercept</span></span>
<span id="cb15-12"><a href="#cb15-12"></a><span class="do">##         0    0  -0.4725    0    0    0    0    0  -0.0120  79689.809</span></span>
<span id="cb15-13"><a href="#cb15-13"></a><span class="do">## s.e.    0    0   0.1459    0    0    0    0    0   0.1444   2674.593</span></span>
<span id="cb15-14"><a href="#cb15-14"></a><span class="do">## </span></span>
<span id="cb15-15"><a href="#cb15-15"></a><span class="do">## sigma^2 estimated as 1399698249:  log likelihood = -717.31,  aic = 1442.61</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note that the Box.test() input requires us to specify the number of degrees of freedom— that is, how many model parameters were free to be estimated rather than being con‐ strained to a specific value. In this case, the free parameters were the intercept as well as the MA3 and MA9 terms.</p>
<p>We cannot reject the null hypothesis that there is no temporal correlation between residual points.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">Box.test</span>(ma.est<span class="sc">$</span>residuals, <span class="at">lag =</span> <span class="dv">10</span>, <span class="at">type =</span> <span class="st">"Ljung"</span>, <span class="at">fitdf =</span> <span class="dv">3</span>)</span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="do">## </span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="do">##  Box-Ljung test</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="do">## </span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="do">## data:  ma.est$residuals</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="do">## X-squared = 7.6516, df = 7, p-value = 0.3643</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="calculating-forecast-by-hand-1" class="level3">
<h3 class="anchored" data-anchor-id="calculating-forecast-by-hand-1">calculating forecast by hand</h3>
<p>this is equasion for proces MA(1), based on this equasation parameters are calculated</p>
<p><span class="math inline">\(y_t = μ + θ_1 × e_{t -1} + e_t\)</span> Then if i want to predict future one point forward i am getting following equasation:</p>
<p><span class="math inline">\(y_{t+1} = μ + θ_1 × e_{t} + e_{t+1}\)</span>.</p>
<p>Since I don’t know value of$ e_{t+1}$ it is diminishing and i finished with following equsation</p>
<p>$y_{t+1} = μ + θ_1 × e_{t} $.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="fu">fitted</span>(ma.est, <span class="at">h=</span><span class="dv">1</span>)[<span class="dv">11</span>]</span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="do">## [1] 102868.2</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="fu">fitted</span>(ma.est)</span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="do">## Time Series:</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="do">## Start = 1 </span></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="do">## End = 60 </span></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="do">## Frequency = 1 </span></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="do">##  [1]  90116.64  80626.91  74090.45  38321.61  74734.77 101153.20  65930.90</span></span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="do">##  [8] 106351.80 104138.05  86938.99 102868.16  80502.02  81466.01  77619.15</span></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="do">## [15] 100984.93  81463.10  61622.54  79660.81  88563.91  65370.99 104679.89</span></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="do">## [22]  48047.39  73070.29 115034.16  80034.03  70052.29  70728.85  90437.86</span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="do">## [29]  80684.44  91533.59 101668.18  42273.27  93055.40  68187.65  75863.50</span></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="do">## [36]  40195.15  82368.91  90605.60  69924.83  54032.55  90866.20  85839.41</span></span>
<span id="cb17-15"><a href="#cb17-15"></a><span class="do">## [43]  64932.70  43030.64  85575.32  76561.14  82047.95  95683.35  66553.13</span></span>
<span id="cb17-16"><a href="#cb17-16"></a><span class="do">## [50]  89532.20  85102.64  80937.97  93926.74  47468.84  75223.67 100887.60</span></span>
<span id="cb17-17"><a href="#cb17-17"></a><span class="do">## [57]  92059.32  84459.85  67112.16  80917.23</span></span>
<span id="cb17-18"><a href="#cb17-18"></a>ma.est<span class="sc">$</span>residuals</span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="do">## Time Series:</span></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="do">## Start = 1 </span></span>
<span id="cb17-21"><a href="#cb17-21"></a><span class="do">## End = 60 </span></span>
<span id="cb17-22"><a href="#cb17-22"></a><span class="do">## Frequency = 1 </span></span>
<span id="cb17-23"><a href="#cb17-23"></a><span class="do">##  [1]  98294.3562   8834.0914 -52785.4519  30732.3920 -58323.7702 -53631.2031</span></span>
<span id="cb17-24"><a href="#cb17-24"></a><span class="do">##  [7] -17661.8971 -49686.8020   -762.0520  -4543.9878   5850.8372 -43809.0231</span></span>
<span id="cb17-25"><a href="#cb17-25"></a><span class="do">## [13]  -3313.0118  39517.8450     63.0688 -18664.1029  30161.4574 -51787.8125</span></span>
<span id="cb17-26"><a href="#cb17-26"></a><span class="do">## [19]  67053.0856  13007.0069 -74805.8883   -254.3946  19630.7094  20279.8374</span></span>
<span id="cb17-27"><a href="#cb17-27"></a><span class="do">## [25] -24450.0269  -2435.2854 -23165.8452 -46507.8590  78688.5556 -28801.5938</span></span>
<span id="cb17-28"><a href="#cb17-28"></a><span class="do">## [31]  24963.8186   8159.7332  84173.5994  -4488.6489 -25100.4994  21397.8481</span></span>
<span id="cb17-29"><a href="#cb17-29"></a><span class="do">## [37]  53666.0948 -23860.5964 -15152.8251  31345.4544  78221.8009 -12999.4118</span></span>
<span id="cb17-30"><a href="#cb17-30"></a><span class="do">## [43]   5258.2953  -4384.6369 -33463.3232  27005.8621 -22816.9525 -11125.3541</span></span>
<span id="cb17-31"><a href="#cb17-31"></a><span class="do">## [49]  -2775.1259 -30019.2045  69041.3579   8766.0307 -44282.7441 -25895.8370</span></span>
<span id="cb17-32"><a href="#cb17-32"></a><span class="do">## [55] -10024.6734  27381.4011  -4351.3204   6907.1472 -17000.1616 -24902.2280</span></span>
<span id="cb17-33"><a href="#cb17-33"></a></span>
<span id="cb17-34"><a href="#cb17-34"></a>ts<span class="ot">&lt;-</span>df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span></span>
<span id="cb17-35"><a href="#cb17-35"></a></span>
<span id="cb17-36"><a href="#cb17-36"></a>ma.est<span class="sc">$</span>coef[<span class="st">'intercept'</span>]</span>
<span id="cb17-37"><a href="#cb17-37"></a><span class="do">## intercept </span></span>
<span id="cb17-38"><a href="#cb17-38"></a><span class="do">##  79689.81</span></span>
<span id="cb17-39"><a href="#cb17-39"></a></span>
<span id="cb17-40"><a href="#cb17-40"></a>res<span class="ot">=</span><span class="fu">c</span>()</span>
<span id="cb17-41"><a href="#cb17-41"></a>h<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb17-42"><a href="#cb17-42"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">11</span>,<span class="dv">60</span>)){</span>
<span id="cb17-43"><a href="#cb17-43"></a>  res <span class="ot">=</span> <span class="fu">c</span>(res,</span>
<span id="cb17-44"><a href="#cb17-44"></a>          ma.est<span class="sc">$</span>coef[<span class="st">'intercept'</span>] <span class="sc">+</span> <span class="co"># ma.est$residuals[i] tego nie wliczam bo nie znam w błedu 1 punkt w przyszłość</span></span>
<span id="cb17-45"><a href="#cb17-45"></a>  ma.est<span class="sc">$</span>coef[[<span class="st">'ma3'</span>]] <span class="sc">*</span> ma.est<span class="sc">$</span>residuals[i<span class="dv">-3</span> <span class="sc">+</span>h] <span class="sc">+</span>   </span>
<span id="cb17-46"><a href="#cb17-46"></a>  ma.est<span class="sc">$</span>coef[[<span class="st">'ma9'</span>]] <span class="sc">*</span> ma.est<span class="sc">$</span>residuals[i<span class="dv">-9</span> <span class="sc">+</span>h] </span>
<span id="cb17-47"><a href="#cb17-47"></a>  )</span>
<span id="cb17-48"><a href="#cb17-48"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="forecasting-1-time-step-ahead-1" class="level3">
<h3 class="anchored" data-anchor-id="forecasting-1-time-step-ahead-1">forecasting 1 time step ahead</h3>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">fitted</span>(ma.est, <span class="at">h=</span><span class="dv">1</span>)</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="do">## Time Series:</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="do">## Start = 1 </span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="do">## End = 60 </span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="do">## Frequency = 1 </span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="do">##  [1]  90116.64  80626.91  74090.45  38321.61  74734.77 101153.20  65930.90</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="do">##  [8] 106351.80 104138.05  86938.99 102868.16  80502.02  81466.01  77619.15</span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="do">## [15] 100984.93  81463.10  61622.54  79660.81  88563.91  65370.99 104679.89</span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="do">## [22]  48047.39  73070.29 115034.16  80034.03  70052.29  70728.85  90437.86</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="do">## [29]  80684.44  91533.59 101668.18  42273.27  93055.40  68187.65  75863.50</span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="do">## [36]  40195.15  82368.91  90605.60  69924.83  54032.55  90866.20  85839.41</span></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="do">## [43]  64932.70  43030.64  85575.32  76561.14  82047.95  95683.35  66553.13</span></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="do">## [50]  89532.20  85102.64  80937.97  93926.74  47468.84  75223.67 100887.60</span></span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="do">## [57]  92059.32  84459.85  67112.16  80917.23</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>MA models exhibit strong mean reversion and so forecasts rapidly converge to the mean of the process. This makes sense given that the process is considered to be a function of white noise.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">plot</span>(<span class="fu">c</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>,<span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">12</span>)), <span class="at">type =</span> <span class="st">'l'</span>)</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="fu">lines</span>(<span class="fu">c</span>(<span class="fu">fitted</span>(ma.est, <span class="at">h=</span><span class="dv">1</span>),<span class="fu">predict</span>(ma.est, <span class="at">n.ahead =</span> <span class="dv">12</span>)<span class="sc">$</span>pred)</span>
<span id="cb19-3"><a href="#cb19-3"></a>      , <span class="at">col =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="dv">5</span>) <span class="do">## use the forecast package</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="fu">lines</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">11</span>),res)</span>
<span id="cb19-5"><a href="#cb19-5"></a>      , <span class="at">col =</span> <span class="dv">4</span>, <span class="at">lwd =</span> <span class="dv">2</span>) <span class="do">## by hand</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>If you forecast beyond the range of the model established by its order, the forecast will necessarily be the mean of the process by definition of the process. Consider an MA(1) model: <span class="math inline">\(yt = μ + θ1 × et -1 + et\)</span> To predict one time step in the future, our estimate for <span class="math inline">\(y_{t+1} = μ + θ1 × yt + et\)</span>.</p>
<p>If we want to predict two time steps in the future, our estimate is: <span class="math inline">\(E(y_{t+2} =μ+e_{t+2} +θ_1 ×e_{t+1})=μ+0+θ_1 ×0=μ\)</span></p>
<p>With an MA(1) process we cannot offer an informed prediction beyond one step ahead, and for an MA(q) process in general we cannot offer a more informed predic‐ tion beyond q steps than the mean value emitted by the process. By informed predic‐ tion, I mean one in which our most recent measurements have an impact on the forecast.</p>
<p>We can see this by producing predictions with our MA(9) model that we just fit, and for which we now seek predictions 10 time steps ahead.</p>
<p>When we attempt to predict 10 time steps into the future, we predict the mean for every time step</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">fitted</span>(ma.est, <span class="at">h=</span><span class="dv">10</span>)[<span class="dv">40</span><span class="sc">:</span><span class="dv">50</span>]</span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="do">##  [1] 79689.81 79689.81 79689.81 79689.81 79689.81 79689.81 79689.81 79689.81</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="do">##  [9] 79689.81 79689.81 79689.81</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="fu">fitted</span>(ma.est, <span class="at">h=</span><span class="dv">9</span>)[<span class="dv">40</span><span class="sc">:</span><span class="dv">50</span>]</span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="do">##  [1] 79390.20 79591.88 78679.58 79743.68 79991.06 79433.00 79045.72 79976.18</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="do">##  [9] 79871.67 79313.61 78751.01</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="more-complicated-case" class="level2">
<h2 class="anchored" data-anchor-id="more-complicated-case">more complicated case</h2>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">class</span>(AirPassengers)</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="do">## [1] "ts"</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="co">#This is the start of the time series</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="fu">start</span>(AirPassengers)</span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="do">## [1] 1949    1</span></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="co">#This is the end of the time series</span></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="fu">end</span>(AirPassengers)</span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="do">## [1] 1960   12</span></span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="co">#The cycle of this time series is 12months in a year</span></span>
<span id="cb21-10"><a href="#cb21-10"></a><span class="fu">frequency</span>(AirPassengers)</span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="do">## [1] 12</span></span>
<span id="cb21-12"><a href="#cb21-12"></a><span class="fu">summary</span>(AirPassengers)</span>
<span id="cb21-13"><a href="#cb21-13"></a><span class="do">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb21-14"><a href="#cb21-14"></a><span class="do">##   104.0   180.0   265.5   280.3   360.5   622.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co">#The number of passengers are distributed across the spectrum</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="fu">plot</span>(AirPassengers)</span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="co">#This will plot the time series</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="fu">abline</span>(<span class="at">reg=</span><span class="fu">lm</span>(AirPassengers<span class="sc">~</span><span class="fu">time</span>(AirPassengers)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># This will fit in a line</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">cycle</span>(AirPassengers)</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="do">##      Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="do">## 1949   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="do">## 1950   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="do">## 1951   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="do">## 1952   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="do">## 1953   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="do">## 1954   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="do">## 1955   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="do">## 1956   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="do">## 1957   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="do">## 1958   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="do">## 1959   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="do">## 1960   1   2   3   4   5   6   7   8   9  10  11  12</span></span>
<span id="cb24-15"><a href="#cb24-15"></a></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="co">#This will print the cycle across years.</span></span>
<span id="cb24-17"><a href="#cb24-17"></a></span>
<span id="cb24-18"><a href="#cb24-18"></a><span class="fu">plot</span>(<span class="fu">aggregate</span>(AirPassengers,<span class="at">FUN=</span>mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co">#This will aggregate the cycles and display a year on year trend</span></span>
<span id="cb25-2"><a href="#cb25-2"></a></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="fu">boxplot</span>(AirPassengers<span class="sc">~</span><span class="fu">cycle</span>(AirPassengers))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-24-2.png" class="img-fluid" style="width:100.0%"></p>
</div>
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="co">#Box plot across months will give us a sense on seasonal effect</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="important-inferences" class="level3">
<h3 class="anchored" data-anchor-id="important-inferences">Important Inferences</h3>
<ol type="1">
<li><p>The year on year trend clearly shows that the #passengers have been increasing without fail.</p></li>
<li><p>The variance and the mean value in July and August is much higher than rest of the months.</p></li>
<li><p>Even though the mean value of each month is quite different their variance is small. Hence, we have strong seasonal effect with a cycle of 12 months or less.</p></li>
</ol>
<p>Exploring data becomes most important in a time series model – without this exploration, you will not know whether a series is stationary or not. As in this case we already know many details about the kind of model we are looking out for.</p>
</section>
<section id="solving-unstationary-issues" class="level3">
<h3 class="anchored" data-anchor-id="solving-unstationary-issues">Solving unstationary issues</h3>
<p>We know that we need to address two issues before we test stationary series. One, we need to remove unequal variances. We do this using log of the series. Two, we need to address the trend component. We do this by taking difference of the series. Now, let’s test the resultant series.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>tseries<span class="sc">::</span><span class="fu">adf.test</span>(<span class="fu">diff</span>(<span class="fu">log</span>(AirPassengers)), <span class="at">alternative=</span><span class="st">"stationary"</span>, <span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="do">## </span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="do">##  Augmented Dickey-Fuller Test</span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="do">## </span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="do">## data:  diff(log(AirPassengers))</span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="do">## Dickey-Fuller = -9.6003, Lag order = 0, p-value = 0.01</span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="do">## alternative hypothesis: stationary</span></span>
<span id="cb27-8"><a href="#cb27-8"></a></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="fu">log</span>(AirPassengers)</span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="do">##           Jan      Feb      Mar      Apr      May      Jun      Jul      Aug</span></span>
<span id="cb27-11"><a href="#cb27-11"></a><span class="do">## 1949 4.718499 4.770685 4.882802 4.859812 4.795791 4.905275 4.997212 4.997212</span></span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="do">## 1950 4.744932 4.836282 4.948760 4.905275 4.828314 5.003946 5.135798 5.135798</span></span>
<span id="cb27-13"><a href="#cb27-13"></a><span class="do">## 1951 4.976734 5.010635 5.181784 5.093750 5.147494 5.181784 5.293305 5.293305</span></span>
<span id="cb27-14"><a href="#cb27-14"></a><span class="do">## 1952 5.141664 5.192957 5.262690 5.198497 5.209486 5.384495 5.438079 5.488938</span></span>
<span id="cb27-15"><a href="#cb27-15"></a><span class="do">## 1953 5.278115 5.278115 5.463832 5.459586 5.433722 5.493061 5.575949 5.605802</span></span>
<span id="cb27-16"><a href="#cb27-16"></a><span class="do">## 1954 5.318120 5.236442 5.459586 5.424950 5.455321 5.575949 5.710427 5.680173</span></span>
<span id="cb27-17"><a href="#cb27-17"></a><span class="do">## 1955 5.488938 5.451038 5.587249 5.594711 5.598422 5.752573 5.897154 5.849325</span></span>
<span id="cb27-18"><a href="#cb27-18"></a><span class="do">## 1956 5.648974 5.624018 5.758902 5.746203 5.762051 5.924256 6.023448 6.003887</span></span>
<span id="cb27-19"><a href="#cb27-19"></a><span class="do">## 1957 5.752573 5.707110 5.874931 5.852202 5.872118 6.045005 6.142037 6.146329</span></span>
<span id="cb27-20"><a href="#cb27-20"></a><span class="do">## 1958 5.828946 5.762051 5.891644 5.852202 5.894403 6.075346 6.196444 6.224558</span></span>
<span id="cb27-21"><a href="#cb27-21"></a><span class="do">## 1959 5.886104 5.834811 6.006353 5.981414 6.040255 6.156979 6.306275 6.326149</span></span>
<span id="cb27-22"><a href="#cb27-22"></a><span class="do">## 1960 6.033086 5.968708 6.037871 6.133398 6.156979 6.282267 6.432940 6.406880</span></span>
<span id="cb27-23"><a href="#cb27-23"></a><span class="do">##           Sep      Oct      Nov      Dec</span></span>
<span id="cb27-24"><a href="#cb27-24"></a><span class="do">## 1949 4.912655 4.779123 4.644391 4.770685</span></span>
<span id="cb27-25"><a href="#cb27-25"></a><span class="do">## 1950 5.062595 4.890349 4.736198 4.941642</span></span>
<span id="cb27-26"><a href="#cb27-26"></a><span class="do">## 1951 5.214936 5.087596 4.983607 5.111988</span></span>
<span id="cb27-27"><a href="#cb27-27"></a><span class="do">## 1952 5.342334 5.252273 5.147494 5.267858</span></span>
<span id="cb27-28"><a href="#cb27-28"></a><span class="do">## 1953 5.468060 5.351858 5.192957 5.303305</span></span>
<span id="cb27-29"><a href="#cb27-29"></a><span class="do">## 1954 5.556828 5.433722 5.313206 5.433722</span></span>
<span id="cb27-30"><a href="#cb27-30"></a><span class="do">## 1955 5.743003 5.613128 5.468060 5.627621</span></span>
<span id="cb27-31"><a href="#cb27-31"></a><span class="do">## 1956 5.872118 5.723585 5.602119 5.723585</span></span>
<span id="cb27-32"><a href="#cb27-32"></a><span class="do">## 1957 6.001415 5.849325 5.720312 5.817111</span></span>
<span id="cb27-33"><a href="#cb27-33"></a><span class="do">## 1958 6.001415 5.883322 5.736572 5.820083</span></span>
<span id="cb27-34"><a href="#cb27-34"></a><span class="do">## 1959 6.137727 6.008813 5.891644 6.003887</span></span>
<span id="cb27-35"><a href="#cb27-35"></a><span class="do">## 1960 6.230481 6.133398 5.966147 6.068426</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We see that the series is stationary enough to do any kind of time series modelling.</p>
<p>Next step is to find the right parameters to be used in the ARIMA model. We already know that the ‘d’ component is 1 as we need 1 difference to make the series stationary. We do this using the Correlation plots. Following are the ACF plots for the series:</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">acf</span>(<span class="fu">diff</span>(<span class="fu">log</span>(AirPassengers)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a></span>
<span id="cb29-2"><a href="#cb29-2"></a></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="fu">pacf</span>(<span class="fu">diff</span>(<span class="fu">log</span>(AirPassengers)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-26-2.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<p>Clearly, ACF plot cuts off after the first lag. Hence, we understood&nbsp;that value of p should be 0 as the ACF is the curve getting a cut off. While value of q should be 1 or 2. After a few iterations, we found that (0,1,1) as (p,d,q) comes out to be the combination with least AIC and BIC.</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>(fit <span class="ot">&lt;-</span> <span class="fu">arima</span>(<span class="fu">log</span>(AirPassengers), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>),<span class="at">seasonal =</span> <span class="fu">list</span>(<span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">period =</span> <span class="dv">12</span>)))</span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="do">## </span></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="do">## Call:</span></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="do">## arima(x = log(AirPassengers), order = c(0, 1, 1), seasonal = list(order = c(0, </span></span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="do">##     1, 1), period = 12))</span></span>
<span id="cb30-6"><a href="#cb30-6"></a><span class="do">## </span></span>
<span id="cb30-7"><a href="#cb30-7"></a><span class="do">## Coefficients:</span></span>
<span id="cb30-8"><a href="#cb30-8"></a><span class="do">##           ma1     sma1</span></span>
<span id="cb30-9"><a href="#cb30-9"></a><span class="do">##       -0.4018  -0.5569</span></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="do">## s.e.   0.0896   0.0731</span></span>
<span id="cb30-11"><a href="#cb30-11"></a><span class="do">## </span></span>
<span id="cb30-12"><a href="#cb30-12"></a><span class="do">## sigma^2 estimated as 0.001348:  log likelihood = 244.7,  aic = -483.4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s fit an ARIMA model and predict the future 10 years. Also, we will try fitting in a seasonal component in the ARIMA formulation. Then, we will visualize the prediction along with the training data. You can use the following code to do the same :</p>
<div class="cell">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>(fit <span class="ot">&lt;-</span> <span class="fu">arima</span>(<span class="fu">log</span>(AirPassengers), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>),<span class="at">seasonal =</span> <span class="fu">list</span>(<span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">period =</span> <span class="dv">12</span>)))</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="do">## </span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="do">## Call:</span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="do">## arima(x = log(AirPassengers), order = c(0, 1, 1), seasonal = list(order = c(0, </span></span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="do">##     1, 1), period = 12))</span></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="do">## </span></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="do">## Coefficients:</span></span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="do">##           ma1     sma1</span></span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="do">##       -0.4018  -0.5569</span></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="do">## s.e.   0.0896   0.0731</span></span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="do">## </span></span>
<span id="cb31-12"><a href="#cb31-12"></a><span class="do">## sigma^2 estimated as 0.001348:  log likelihood = 244.7,  aic = -483.4</span></span>
<span id="cb31-13"><a href="#cb31-13"></a></span>
<span id="cb31-14"><a href="#cb31-14"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">n.ahead =</span> <span class="dv">10</span><span class="sc">*</span><span class="dv">12</span>)</span>
<span id="cb31-15"><a href="#cb31-15"></a></span>
<span id="cb31-16"><a href="#cb31-16"></a><span class="fu">ts.plot</span>(AirPassengers,<span class="fl">2.718</span><span class="sc">^</span>pred<span class="sc">$</span>pred, <span class="at">log =</span> <span class="st">"y"</span>, <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>


<!-- -->

</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="an">title:</span><span class="co"> "TS - forecast"</span></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="an">tags:</span><span class="co"> []</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="an">categories:</span><span class="co"> ['Time Series', 'forecast']</span></span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="an">editor:</span><span class="co"> source</span></span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="an">toc:</span><span class="co"> TRUE</span></span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="co">---</span></span>
<span id="cb32-8"><a href="#cb32-8"></a></span>
<span id="cb32-9"><a href="#cb32-9"></a><span class="in">```{r markdown_parameters, include=FALSE}</span></span>
<span id="cb32-10"><a href="#cb32-10"></a><span class="co">#markdown ----</span></span>
<span id="cb32-11"><a href="#cb32-11"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="co">#fig.width=12, </span></span>
<span id="cb32-12"><a href="#cb32-12"></a>                      <span class="at">fig.height=</span><span class="dv">4</span>,</span>
<span id="cb32-13"><a href="#cb32-13"></a>                       <span class="at">out.width =</span> <span class="st">'100%'</span></span>
<span id="cb32-14"><a href="#cb32-14"></a>                      ) </span>
<span id="cb32-15"><a href="#cb32-15"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">include =</span><span class="cn">TRUE</span>, <span class="co">#prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.</span></span>
<span id="cb32-16"><a href="#cb32-16"></a></span>
<span id="cb32-17"><a href="#cb32-17"></a>                      <span class="at">warning =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-18"><a href="#cb32-18"></a>                      <span class="at">message =</span><span class="cn">FALSE</span>,</span>
<span id="cb32-19"><a href="#cb32-19"></a>                      <span class="at">collapse=</span><span class="cn">TRUE</span>,</span>
<span id="cb32-20"><a href="#cb32-20"></a>                      <span class="at">error=</span><span class="cn">TRUE</span></span>
<span id="cb32-21"><a href="#cb32-21"></a>                      )</span>
<span id="cb32-22"><a href="#cb32-22"></a><span class="fu">options</span>(<span class="at">scipen=</span><span class="dv">999</span>)</span>
<span id="cb32-23"><a href="#cb32-23"></a><span class="in">```</span></span>
<span id="cb32-24"><a href="#cb32-24"></a></span>
<span id="cb32-25"><a href="#cb32-25"></a><span class="in">```{r, include =FALSE}</span></span>
<span id="cb32-26"><a href="#cb32-26"></a></span>
<span id="cb32-27"><a href="#cb32-27"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb32-28"><a href="#cb32-28"></a><span class="fu">library</span>(zoo)</span>
<span id="cb32-29"><a href="#cb32-29"></a><span class="fu">library</span>(forecast)</span>
<span id="cb32-30"><a href="#cb32-30"></a></span>
<span id="cb32-31"><a href="#cb32-31"></a></span>
<span id="cb32-32"><a href="#cb32-32"></a><span class="fu">Sys.setenv</span>(<span class="at">RETICULATE_PYTHON =</span> <span class="st">"/Users/lrabalski1/miniforge3/envs/everyday_use/bin/python"</span>)</span>
<span id="cb32-33"><a href="#cb32-33"></a></span>
<span id="cb32-34"><a href="#cb32-34"></a>myenvs<span class="ot">=</span><span class="fu">conda_list</span>()</span>
<span id="cb32-35"><a href="#cb32-35"></a>envname<span class="ot">=</span>myenvs<span class="sc">$</span>name[<span class="dv">3</span>]</span>
<span id="cb32-36"><a href="#cb32-36"></a><span class="fu">use_condaenv</span>(envname, <span class="at">required =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-37"><a href="#cb32-37"></a></span>
<span id="cb32-38"><a href="#cb32-38"></a><span class="in">```</span></span>
<span id="cb32-39"><a href="#cb32-39"></a></span>
<span id="cb32-40"><a href="#cb32-40"></a><span class="co">[</span><span class="ot">data set source</span><span class="co">](https://archive.ics.uci.edu/ml/datasets/Daily+Demand+Forecasting+Orders)</span></span>
<span id="cb32-41"><a href="#cb32-41"></a></span>
<span id="cb32-42"><a href="#cb32-42"></a><span class="in">```{r, include =FALSE}</span></span>
<span id="cb32-43"><a href="#cb32-43"></a>data_file_path <span class="ot">=</span> <span class="st">'/Users/lrabalski1/Desktop/prv/data/'</span></span>
<span id="cb32-44"><a href="#cb32-44"></a></span>
<span id="cb32-45"><a href="#cb32-45"></a>df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">url</span>(<span class="st">"https://archive.ics.uci.edu/ml/machine-learning-databases/00409/Daily_Demand_Forecasting_Orders.csv"</span>), <span class="at">header=</span><span class="cn">TRUE</span>, <span class="at">sep=</span><span class="st">';'</span>) </span>
<span id="cb32-46"><a href="#cb32-46"></a><span class="in">```</span></span>
<span id="cb32-47"><a href="#cb32-47"></a></span>
<span id="cb32-48"><a href="#cb32-48"></a><span class="fu"># simple case</span></span>
<span id="cb32-49"><a href="#cb32-49"></a></span>
<span id="cb32-50"><a href="#cb32-50"></a><span class="fu">## general exploration of TS</span></span>
<span id="cb32-51"><a href="#cb32-51"></a></span>
<span id="cb32-52"><a href="#cb32-52"></a>First we plot the data in chronological order. Since we will model this as an AR process, we look to the PACF to set a cutoff on the order of the process</span>
<span id="cb32-53"><a href="#cb32-53"></a></span>
<span id="cb32-54"><a href="#cb32-54"></a>The database was collected during 60 days, this is a real database of a Brazilian company of large logistics. Twelve predictive attributes and a target that is the total of orders for daily.</span>
<span id="cb32-55"><a href="#cb32-55"></a></span>
<span id="cb32-56"><a href="#cb32-56"></a>Data looks stationary.</span>
<span id="cb32-57"><a href="#cb32-57"></a></span>
<span id="cb32-60"><a href="#cb32-60"></a><span class="in">```{r}</span></span>
<span id="cb32-61"><a href="#cb32-61"></a><span class="fu">plot</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>, <span class="at">type=</span><span class="st">'l'</span>)</span>
<span id="cb32-62"><a href="#cb32-62"></a><span class="fu">abline</span>(<span class="at">reg=</span><span class="fu">lm</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span><span class="sc">~</span><span class="fu">index</span>(df)))</span>
<span id="cb32-63"><a href="#cb32-63"></a><span class="in">```</span></span>
<span id="cb32-64"><a href="#cb32-64"></a></span>
<span id="cb32-65"><a href="#cb32-65"></a><span class="fu">## AR</span></span>
<span id="cb32-66"><a href="#cb32-66"></a></span>
<span id="cb32-67"><a href="#cb32-67"></a>As name suggest autoregression is regression made upon past values. The simplest autoregression model is known as AR(1): $y_t=b_0+b_1*y_{t-1}+e_t$ $e_t$ is changeable within time error with stable variance and mean = 0.</span>
<span id="cb32-68"><a href="#cb32-68"></a></span>
<span id="cb32-69"><a href="#cb32-69"></a><span class="fu">### selecting parameter of AR</span></span>
<span id="cb32-70"><a href="#cb32-70"></a></span>
<span id="cb32-73"><a href="#cb32-73"></a><span class="in">```{r}</span></span>
<span id="cb32-74"><a href="#cb32-74"></a><span class="fu">pacf</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>)</span>
<span id="cb32-75"><a href="#cb32-75"></a><span class="in">```</span></span>
<span id="cb32-76"><a href="#cb32-76"></a></span>
<span id="cb32-77"><a href="#cb32-77"></a>We can see that the value of the PACF crosses the 5% significance threshold at lag 3. This is consistent with the results from the ar() function available in R's stats package. ar() automatically chooses the order of an autoregressive model if one is not specified:</span>
<span id="cb32-78"><a href="#cb32-78"></a></span>
<span id="cb32-81"><a href="#cb32-81"></a><span class="in">```{r}</span></span>
<span id="cb32-82"><a href="#cb32-82"></a><span class="fu">ar</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>, <span class="at">method =</span> <span class="st">"mle"</span>)</span>
<span id="cb32-83"><a href="#cb32-83"></a><span class="in">```</span></span>
<span id="cb32-84"><a href="#cb32-84"></a></span>
<span id="cb32-85"><a href="#cb32-85"></a>Notice that the ar() function has also provided us with the coefficients for the model. We may, however, want to limit the coefficients. For example, looking at the PACF, we might wonder whether we really want to include a coefficient for the lag -- 1 term or whether we should assign that term a mandatory coefficient of 0 given that its PACF value is well below the threshold used for significance. In this case, we can use the arima() function also from the stats package. Here, we demonstrate how to call the function to fit an AR(3), by setting the order parameter to c(3, 0, 0), where 3 refers to the order of the AR component</span>
<span id="cb32-86"><a href="#cb32-86"></a></span>
<span id="cb32-89"><a href="#cb32-89"></a><span class="in">```{r}</span></span>
<span id="cb32-90"><a href="#cb32-90"></a>est <span class="ot">&lt;-</span> <span class="fu">arima</span>(<span class="at">x =</span> df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>,<span class="at">order =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb32-91"><a href="#cb32-91"></a>est</span>
<span id="cb32-92"><a href="#cb32-92"></a><span class="in">```</span></span>
<span id="cb32-93"><a href="#cb32-93"></a></span>
<span id="cb32-94"><a href="#cb32-94"></a>To inject prior knowledge or opinion into our model, we can constraint a coefficient to be 0. For example, if we want to constrain the lag -- 1 term to remain 0 in our model, we use the following call:</span>
<span id="cb32-95"><a href="#cb32-95"></a></span>
<span id="cb32-98"><a href="#cb32-98"></a><span class="in">```{r}</span></span>
<span id="cb32-99"><a href="#cb32-99"></a>est<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">arima</span>(<span class="at">x =</span>  df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>,<span class="at">order =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">0</span>), </span>
<span id="cb32-100"><a href="#cb32-100"></a>               <span class="at">fixed =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>))</span>
<span id="cb32-101"><a href="#cb32-101"></a></span>
<span id="cb32-102"><a href="#cb32-102"></a></span>
<span id="cb32-103"><a href="#cb32-103"></a><span class="in">```</span></span>
<span id="cb32-104"><a href="#cb32-104"></a></span>
<span id="cb32-105"><a href="#cb32-105"></a>We now inspect our model performance on our training data to assess the goodness of fit of our model to this data set. We can do this in two ways. First, we plot the ACF of the residuals (that, is the errors) to see if there is a pattern of self-correlation that our model does not cover.</span>
<span id="cb32-106"><a href="#cb32-106"></a></span>
<span id="cb32-107"><a href="#cb32-107"></a>Plotting the residuals is quite simple thanks to the output of the arima() function</span>
<span id="cb32-108"><a href="#cb32-108"></a></span>
<span id="cb32-111"><a href="#cb32-111"></a><span class="in">```{r}</span></span>
<span id="cb32-112"><a href="#cb32-112"></a><span class="fu">acf</span>(est<span class="fl">.1</span><span class="sc">$</span>residuals)</span>
<span id="cb32-113"><a href="#cb32-113"></a>est<span class="fl">.1</span></span>
<span id="cb32-114"><a href="#cb32-114"></a><span class="in">```</span></span>
<span id="cb32-115"><a href="#cb32-115"></a></span>
<span id="cb32-116"><a href="#cb32-116"></a>None of the values of the ACF cross the significance threshold.</span>
<span id="cb32-117"><a href="#cb32-117"></a></span>
<span id="cb32-118"><a href="#cb32-118"></a>We do not see a pattern of self-correlation here among the residuals (i.e., the error terms). If we had seen such a pattern, we would likely want to return to our original model and consider including additional terms to add complexity to account for the significant autocorrelation of the residuals.</span>
<span id="cb32-119"><a href="#cb32-119"></a></span>
<span id="cb32-120"><a href="#cb32-120"></a><span class="fu">### forecasting 1 time step ahead</span></span>
<span id="cb32-121"><a href="#cb32-121"></a></span>
<span id="cb32-122"><a href="#cb32-122"></a>applying by hand</span>
<span id="cb32-123"><a href="#cb32-123"></a></span>
<span id="cb32-124"><a href="#cb32-124"></a>what's important there are different type of parametrizations of ARIMA models</span>
<span id="cb32-125"><a href="#cb32-125"></a></span>
<span id="cb32-126"><a href="#cb32-126"></a>There are multiple (equivalent) parametrizations for ARIMA models. There's the one you quote (sometimes called the ARMAX parametrization):</span>
<span id="cb32-127"><a href="#cb32-127"></a></span>
<span id="cb32-128"><a href="#cb32-128"></a>$y_t = \phi y_{t-1} + c + \epsilon_t$</span>
<span id="cb32-129"><a href="#cb32-129"></a></span>
<span id="cb32-130"><a href="#cb32-130"></a>And the equivalent regression with ARMA errors parametrization:</span>
<span id="cb32-131"><a href="#cb32-131"></a></span>
<span id="cb32-132"><a href="#cb32-132"></a>$(y_t - c') = \phi (y_{t-1} - c') + \epsilon_t$</span>
<span id="cb32-133"><a href="#cb32-133"></a></span>
<span id="cb32-134"><a href="#cb32-134"></a>The forecast package uses the second parametrization.</span>
<span id="cb32-135"><a href="#cb32-135"></a></span>
<span id="cb32-136"><a href="#cb32-136"></a>The package author explains the difference between the two parametrizations and the rationale for choosing this one on his blog. Mostly, when adding other regressors (other than the constant), this version is easier to interpret. Since the function forecast::Arima allows for other regressors, it makes sense to treat them all in the same way.</span>
<span id="cb32-137"><a href="#cb32-137"></a></span>
<span id="cb32-138"><a href="#cb32-138"></a><span class="co">[</span><span class="ot">url</span><span class="co">](https://stats.stackexchange.com/questions/236633/r-arima-order1-0-0-forecast-not-giving-what-expected)</span></span>
<span id="cb32-139"><a href="#cb32-139"></a></span>
<span id="cb32-142"><a href="#cb32-142"></a><span class="in">```{r}</span></span>
<span id="cb32-143"><a href="#cb32-143"></a>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]</span>
<span id="cb32-144"><a href="#cb32-144"></a>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar1'</span>]</span>
<span id="cb32-145"><a href="#cb32-145"></a>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar2'</span>]</span>
<span id="cb32-146"><a href="#cb32-146"></a>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar3'</span>]</span>
<span id="cb32-147"><a href="#cb32-147"></a></span>
<span id="cb32-148"><a href="#cb32-148"></a></span>
<span id="cb32-149"><a href="#cb32-149"></a>x<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>,<span class="cn">NA</span>,df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>)</span>
<span id="cb32-150"><a href="#cb32-150"></a></span>
<span id="cb32-151"><a href="#cb32-151"></a>y_pred <span class="ot">=</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(<span class="fu">zoo</span>(x),</span>
<span id="cb32-152"><a href="#cb32-152"></a>               <span class="at">width=</span><span class="dv">3</span>,</span>
<span id="cb32-153"><a href="#cb32-153"></a>               <span class="at">FUN=</span><span class="cf">function</span>(w){</span>
<span id="cb32-154"><a href="#cb32-154"></a>                 est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>] <span class="sc">+</span> </span>
<span id="cb32-155"><a href="#cb32-155"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar1'</span>]<span class="sc">*</span>(w[<span class="dv">3</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb32-156"><a href="#cb32-156"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar2'</span>]<span class="sc">*</span>(w[<span class="dv">2</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb32-157"><a href="#cb32-157"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar3'</span>]<span class="sc">*</span>(w[<span class="dv">1</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) </span>
<span id="cb32-158"><a href="#cb32-158"></a>                 </span>
<span id="cb32-159"><a href="#cb32-159"></a>                </span>
<span id="cb32-160"><a href="#cb32-160"></a>                 },</span>
<span id="cb32-161"><a href="#cb32-161"></a>               <span class="at">partial =</span> <span class="cn">FALSE</span></span>
<span id="cb32-162"><a href="#cb32-162"></a>               )</span>
<span id="cb32-163"><a href="#cb32-163"></a></span>
<span id="cb32-164"><a href="#cb32-164"></a>y_pred <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">as.vector</span>(y_pred))</span>
<span id="cb32-165"><a href="#cb32-165"></a></span>
<span id="cb32-166"><a href="#cb32-166"></a><span class="in">```</span></span>
<span id="cb32-167"><a href="#cb32-167"></a></span>
<span id="cb32-170"><a href="#cb32-170"></a><span class="in">```{r}</span></span>
<span id="cb32-171"><a href="#cb32-171"></a><span class="fu">plot</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>, <span class="at">type =</span> <span class="st">'l'</span>)</span>
<span id="cb32-172"><a href="#cb32-172"></a><span class="fu">lines</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>,<span class="at">h=</span><span class="dv">1</span>), <span class="at">col =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="dv">5</span>) <span class="do">## use the forecast package</span></span>
<span id="cb32-173"><a href="#cb32-173"></a><span class="fu">lines</span>(y_pred, <span class="at">col =</span> <span class="dv">6</span>, <span class="at">lwd =</span> <span class="dv">2</span>) <span class="do">## fitted by hand</span></span>
<span id="cb32-174"><a href="#cb32-174"></a><span class="in">```</span></span>
<span id="cb32-175"><a href="#cb32-175"></a></span>
<span id="cb32-176"><a href="#cb32-176"></a>Now let's think about the quality of the forecast. If we calculate the correlation between the predicted value and the actual value, we get 0.29. This is not bad in some contexts, but remember that sometimes differencing the data will remove what seemed like a strong relationship and replace it with one that is essentially random. This will be the case particularly if the data was not truly stationary when we fit it, so that an unidentified trend masquerades as good model performance when it is actually a trait of the data we should have addressed before modeling.</span>
<span id="cb32-177"><a href="#cb32-177"></a></span>
<span id="cb32-178"><a href="#cb32-178"></a>We can difference both the series and the predicted values to see whether the change from one time period to the next is well predicted by the model. Even after differenc‐ ing, our predictions and the data show similar patterns, suggesting our model is a meaningful one</span>
<span id="cb32-179"><a href="#cb32-179"></a></span>
<span id="cb32-182"><a href="#cb32-182"></a><span class="in">```{r}</span></span>
<span id="cb32-183"><a href="#cb32-183"></a><span class="fu">cor</span>(y_pred[<span class="dv">1</span><span class="sc">:</span><span class="dv">60</span>],df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>[<span class="dv">1</span><span class="sc">:</span><span class="dv">60</span>])</span>
<span id="cb32-184"><a href="#cb32-184"></a><span class="fu">cor</span>(<span class="fu">diff</span>(y_pred)[<span class="dv">1</span><span class="sc">:</span><span class="dv">59</span>],<span class="fu">diff</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">59</span>])</span>
<span id="cb32-185"><a href="#cb32-185"></a><span class="fu">plot</span>(<span class="fu">diff</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">59</span>],<span class="fu">diff</span>(y_pred)[<span class="dv">1</span><span class="sc">:</span><span class="dv">59</span>])</span>
<span id="cb32-186"><a href="#cb32-186"></a><span class="in">```</span></span>
<span id="cb32-187"><a href="#cb32-187"></a></span>
<span id="cb32-188"><a href="#cb32-188"></a><span class="fu">### Forecasting many steps into the future</span></span>
<span id="cb32-189"><a href="#cb32-189"></a></span>
<span id="cb32-190"><a href="#cb32-190"></a>Looking back at the original plot of the forecast versus actual values, we see that the main difference between the forecast and the data is that the forecast is less variable than the data.</span>
<span id="cb32-191"><a href="#cb32-191"></a></span>
<span id="cb32-192"><a href="#cb32-192"></a>It may predict the direction of the future correctly, but not the scale of the change from one time period to another. This is not a problem per se but rather reflects the fact that forecasts are means of the predicted distributions and so necessarily will have lower variability than sampled data.</span>
<span id="cb32-193"><a href="#cb32-193"></a></span>
<span id="cb32-194"><a href="#cb32-194"></a>As you can see in the Figure below, the variance of the prediction decreases with increasing forward horizon. The reason for this---which highlights an important limitation of the model---is that the further forward in time we go, the less the actual data matters because the coefficients for input data look only at a finite previous set of time points (in this model, going back only to lag -- 3; i.e., time -- 3). The future prediction approaches the mean value of the series as the time horizon grows, and hence the variance of both the error term and of the forecast values shrinks to 0 as the forecast values tend toward the unconditional mean value.</span>
<span id="cb32-195"><a href="#cb32-195"></a></span>
<span id="cb32-198"><a href="#cb32-198"></a><span class="in">```{r}</span></span>
<span id="cb32-199"><a href="#cb32-199"></a><span class="fu">plot</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>, <span class="at">type =</span> <span class="st">'l'</span>)</span>
<span id="cb32-200"><a href="#cb32-200"></a><span class="fu">lines</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>,<span class="at">h=</span><span class="dv">1</span>), <span class="at">col =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">6</span>) <span class="do">## use the forecast package</span></span>
<span id="cb32-201"><a href="#cb32-201"></a><span class="fu">lines</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>,<span class="at">h=</span><span class="dv">4</span>), <span class="at">col =</span> <span class="dv">4</span>, <span class="at">lwd =</span> <span class="dv">4</span>) <span class="do">## use the forecast package</span></span>
<span id="cb32-202"><a href="#cb32-202"></a><span class="fu">lines</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>,<span class="at">h=</span><span class="dv">7</span>), <span class="at">col =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="dv">2</span>) <span class="do">## use the forecast package</span></span>
<span id="cb32-203"><a href="#cb32-203"></a><span class="in">```</span></span>
<span id="cb32-204"><a href="#cb32-204"></a></span>
<span id="cb32-205"><a href="#cb32-205"></a><span class="fu">### calculating forecast by hand</span></span>
<span id="cb32-206"><a href="#cb32-206"></a></span>
<span id="cb32-207"><a href="#cb32-207"></a>Below how prediction for point 8 in time series in calculcated using window_width=3</span>
<span id="cb32-208"><a href="#cb32-208"></a></span>
<span id="cb32-211"><a href="#cb32-211"></a><span class="in">```{r}</span></span>
<span id="cb32-212"><a href="#cb32-212"></a>ts<span class="ot">&lt;-</span>df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span></span>
<span id="cb32-213"><a href="#cb32-213"></a></span>
<span id="cb32-214"><a href="#cb32-214"></a></span>
<span id="cb32-215"><a href="#cb32-215"></a>y_hat_6_window_1 <span class="ot">=</span> est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>] <span class="sc">+</span> </span>
<span id="cb32-216"><a href="#cb32-216"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar1'</span>]<span class="sc">*</span>(ts[<span class="dv">5</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb32-217"><a href="#cb32-217"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar2'</span>]<span class="sc">*</span>(ts[<span class="dv">4</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb32-218"><a href="#cb32-218"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar3'</span>]<span class="sc">*</span>(ts[<span class="dv">3</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) </span>
<span id="cb32-219"><a href="#cb32-219"></a></span>
<span id="cb32-220"><a href="#cb32-220"></a>y_hat_7_window_2 <span class="ot">=</span> est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>] <span class="sc">+</span> </span>
<span id="cb32-221"><a href="#cb32-221"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar1'</span>]<span class="sc">*</span>(y_hat_6<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb32-222"><a href="#cb32-222"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar2'</span>]<span class="sc">*</span>(ts[<span class="dv">5</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb32-223"><a href="#cb32-223"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar3'</span>]<span class="sc">*</span>(ts[<span class="dv">4</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) </span>
<span id="cb32-224"><a href="#cb32-224"></a></span>
<span id="cb32-225"><a href="#cb32-225"></a>y_hat_8_window_3 <span class="ot">=</span> est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>] <span class="sc">+</span> </span>
<span id="cb32-226"><a href="#cb32-226"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar1'</span>]<span class="sc">*</span>(y_hat_7_window_2<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb32-227"><a href="#cb32-227"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar2'</span>]<span class="sc">*</span>(y_hat_6<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) <span class="sc">+</span> </span>
<span id="cb32-228"><a href="#cb32-228"></a>dplyr<span class="sc">::</span><span class="fu">coalesce</span>(est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'ar3'</span>]<span class="sc">*</span>(ts[<span class="dv">5</span>]<span class="sc">-</span>est<span class="fl">.1</span><span class="sc">$</span>coef[<span class="st">'intercept'</span>]),<span class="dv">0</span>) </span>
<span id="cb32-229"><a href="#cb32-229"></a></span>
<span id="cb32-230"><a href="#cb32-230"></a></span>
<span id="cb32-231"><a href="#cb32-231"></a><span class="fu">fitted</span>(est<span class="fl">.1</span>,<span class="at">h=</span><span class="dv">3</span>)[<span class="dv">8</span>] <span class="sc">==</span> y_hat_8_window_3</span>
<span id="cb32-232"><a href="#cb32-232"></a></span>
<span id="cb32-233"><a href="#cb32-233"></a></span>
<span id="cb32-234"><a href="#cb32-234"></a></span>
<span id="cb32-235"><a href="#cb32-235"></a><span class="in">```</span></span>
<span id="cb32-236"><a href="#cb32-236"></a></span>
<span id="cb32-237"><a href="#cb32-237"></a>Below show how variance is diminishing continously along broader and broader horizont width.</span>
<span id="cb32-238"><a href="#cb32-238"></a></span>
<span id="cb32-241"><a href="#cb32-241"></a><span class="in">```{r}</span></span>
<span id="cb32-242"><a href="#cb32-242"></a><span class="do">## R</span></span>
<span id="cb32-243"><a href="#cb32-243"></a><span class="fu">var</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>, <span class="at">h =</span> <span class="dv">3</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-244"><a href="#cb32-244"></a><span class="fu">var</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>, <span class="at">h =</span> <span class="dv">5</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb32-245"><a href="#cb32-245"></a><span class="fu">var</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>, <span class="at">h =</span> <span class="dv">10</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb32-246"><a href="#cb32-246"></a><span class="fu">var</span>(<span class="fu">fitted</span>(est<span class="fl">.1</span>, <span class="at">h =</span> <span class="dv">20</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb32-247"><a href="#cb32-247"></a><span class="in">```</span></span>
<span id="cb32-248"><a href="#cb32-248"></a></span>
<span id="cb32-249"><a href="#cb32-249"></a><span class="fu">## MA model</span></span>
<span id="cb32-250"><a href="#cb32-250"></a></span>
<span id="cb32-251"><a href="#cb32-251"></a>Do not confuse the MA model (moving average model) with a moving average. They are not the same thing.</span>
<span id="cb32-252"><a href="#cb32-252"></a></span>
<span id="cb32-253"><a href="#cb32-253"></a>MA models are by definition weakly stationary.</span>
<span id="cb32-254"><a href="#cb32-254"></a></span>
<span id="cb32-255"><a href="#cb32-255"></a>A moving average model can be expressed similarly to an autoregressive model except that the terms included in the linear equation refer to present and past error terms rather than present and past values of the process itself. So an MA model of order q is expressed as:</span>
<span id="cb32-256"><a href="#cb32-256"></a></span>
<span id="cb32-257"><a href="#cb32-257"></a>$yt = μ +e_t +θ_1 × e_{t-1} +θ_2 × e_{t-2}...+θ_q × e_{t-q}$</span>
<span id="cb32-258"><a href="#cb32-258"></a></span>
<span id="cb32-259"><a href="#cb32-259"></a><span class="ss">-   </span>Economists talk about these error terms as "shocks" to the system,</span>
<span id="cb32-260"><a href="#cb32-260"></a></span>
<span id="cb32-261"><a href="#cb32-261"></a><span class="ss">-   </span>while someone with an electrical engineering background could talk about this as a series of impulses and the model itself as a finite impulse response filter, meaning that the effects of any particular impulse remain only for a finite period of time.</span>
<span id="cb32-262"><a href="#cb32-262"></a></span>
<span id="cb32-263"><a href="#cb32-263"></a>The wording is unimportant, but the concept of many independent events at different past times affecting the current value of the process, each making an individual contribution, is the main idea.</span>
<span id="cb32-264"><a href="#cb32-264"></a></span>
<span id="cb32-265"><a href="#cb32-265"></a><span class="fu">### selecting parameter of AR</span></span>
<span id="cb32-266"><a href="#cb32-266"></a></span>
<span id="cb32-267"><a href="#cb32-267"></a>We see significant values at lags 3 and 9, so we fit an MA model with these lags.</span>
<span id="cb32-268"><a href="#cb32-268"></a></span>
<span id="cb32-271"><a href="#cb32-271"></a><span class="in">```{r}</span></span>
<span id="cb32-272"><a href="#cb32-272"></a><span class="fu">acf</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>)</span>
<span id="cb32-273"><a href="#cb32-273"></a><span class="in">```</span></span>
<span id="cb32-274"><a href="#cb32-274"></a></span>
<span id="cb32-277"><a href="#cb32-277"></a><span class="in">```{r}</span></span>
<span id="cb32-278"><a href="#cb32-278"></a>ma.est <span class="ot">=</span> <span class="fu">arima</span>(<span class="at">x =</span> df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>,</span>
<span id="cb32-279"><a href="#cb32-279"></a>                     <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">9</span>),</span>
<span id="cb32-280"><a href="#cb32-280"></a>  <span class="at">fixed =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="cn">NA</span>, <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="cn">NA</span>, <span class="cn">NA</span>))</span>
<span id="cb32-281"><a href="#cb32-281"></a>ma.est</span>
<span id="cb32-282"><a href="#cb32-282"></a><span class="in">```</span></span>
<span id="cb32-283"><a href="#cb32-283"></a></span>
<span id="cb32-284"><a href="#cb32-284"></a>Note that the Box.test() input requires us to specify the number of degrees of freedom--- that is, how many model parameters were free to be estimated rather than being con‐ strained to a specific value. In this case, the free parameters were the intercept as well as the MA3 and MA9 terms.</span>
<span id="cb32-285"><a href="#cb32-285"></a></span>
<span id="cb32-286"><a href="#cb32-286"></a>We cannot reject the null hypothesis that there is no temporal correlation between residual points.</span>
<span id="cb32-287"><a href="#cb32-287"></a></span>
<span id="cb32-290"><a href="#cb32-290"></a><span class="in">```{r}</span></span>
<span id="cb32-291"><a href="#cb32-291"></a><span class="fu">Box.test</span>(ma.est<span class="sc">$</span>residuals, <span class="at">lag =</span> <span class="dv">10</span>, <span class="at">type =</span> <span class="st">"Ljung"</span>, <span class="at">fitdf =</span> <span class="dv">3</span>)</span>
<span id="cb32-292"><a href="#cb32-292"></a><span class="in">```</span></span>
<span id="cb32-293"><a href="#cb32-293"></a></span>
<span id="cb32-294"><a href="#cb32-294"></a><span class="fu">### calculating forecast by hand</span></span>
<span id="cb32-295"><a href="#cb32-295"></a></span>
<span id="cb32-296"><a href="#cb32-296"></a>this is equasion for proces MA(1), based on this equasation parameters are calculated</span>
<span id="cb32-297"><a href="#cb32-297"></a></span>
<span id="cb32-298"><a href="#cb32-298"></a>$y_t = μ + θ_1 × e_{t -1} + e_t$ Then if i want to predict future one point forward i am getting following equasation:</span>
<span id="cb32-299"><a href="#cb32-299"></a></span>
<span id="cb32-300"><a href="#cb32-300"></a>$y_{t+1} = μ + θ_1 × e_{t} + e_{t+1}$.</span>
<span id="cb32-301"><a href="#cb32-301"></a></span>
<span id="cb32-302"><a href="#cb32-302"></a>Since I don't know value of\$ e<span class="sc">\_</span>{t+1}\$ it is diminishing and i finished with following equsation</span>
<span id="cb32-303"><a href="#cb32-303"></a></span>
<span id="cb32-304"><a href="#cb32-304"></a>\$y<span class="sc">\_</span>{t+1} = μ + θ_1 × e<span class="sc">\_</span>{t} \$.</span>
<span id="cb32-305"><a href="#cb32-305"></a></span>
<span id="cb32-308"><a href="#cb32-308"></a><span class="in">```{r}</span></span>
<span id="cb32-309"><a href="#cb32-309"></a><span class="fu">fitted</span>(ma.est, <span class="at">h=</span><span class="dv">1</span>)[<span class="dv">11</span>]</span>
<span id="cb32-310"><a href="#cb32-310"></a><span class="fu">fitted</span>(ma.est)</span>
<span id="cb32-311"><a href="#cb32-311"></a>ma.est<span class="sc">$</span>residuals</span>
<span id="cb32-312"><a href="#cb32-312"></a></span>
<span id="cb32-313"><a href="#cb32-313"></a>ts<span class="ot">&lt;-</span>df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span></span>
<span id="cb32-314"><a href="#cb32-314"></a></span>
<span id="cb32-315"><a href="#cb32-315"></a>ma.est<span class="sc">$</span>coef[<span class="st">'intercept'</span>]</span>
<span id="cb32-316"><a href="#cb32-316"></a></span>
<span id="cb32-317"><a href="#cb32-317"></a>res<span class="ot">=</span><span class="fu">c</span>()</span>
<span id="cb32-318"><a href="#cb32-318"></a>h<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb32-319"><a href="#cb32-319"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">11</span>,<span class="dv">60</span>)){</span>
<span id="cb32-320"><a href="#cb32-320"></a>  res <span class="ot">=</span> <span class="fu">c</span>(res,</span>
<span id="cb32-321"><a href="#cb32-321"></a>          ma.est<span class="sc">$</span>coef[<span class="st">'intercept'</span>] <span class="sc">+</span> <span class="co"># ma.est$residuals[i] tego nie wliczam bo nie znam w błedu 1 punkt w przyszłość</span></span>
<span id="cb32-322"><a href="#cb32-322"></a>  ma.est<span class="sc">$</span>coef[[<span class="st">'ma3'</span>]] <span class="sc">*</span> ma.est<span class="sc">$</span>residuals[i<span class="dv">-3</span> <span class="sc">+</span>h] <span class="sc">+</span>   </span>
<span id="cb32-323"><a href="#cb32-323"></a>  ma.est<span class="sc">$</span>coef[[<span class="st">'ma9'</span>]] <span class="sc">*</span> ma.est<span class="sc">$</span>residuals[i<span class="dv">-9</span> <span class="sc">+</span>h] </span>
<span id="cb32-324"><a href="#cb32-324"></a>  )</span>
<span id="cb32-325"><a href="#cb32-325"></a>}</span>
<span id="cb32-326"><a href="#cb32-326"></a></span>
<span id="cb32-327"><a href="#cb32-327"></a></span>
<span id="cb32-328"><a href="#cb32-328"></a></span>
<span id="cb32-329"><a href="#cb32-329"></a></span>
<span id="cb32-330"><a href="#cb32-330"></a></span>
<span id="cb32-331"><a href="#cb32-331"></a><span class="in">```</span></span>
<span id="cb32-332"><a href="#cb32-332"></a></span>
<span id="cb32-333"><a href="#cb32-333"></a><span class="fu">### forecasting 1 time step ahead</span></span>
<span id="cb32-334"><a href="#cb32-334"></a></span>
<span id="cb32-337"><a href="#cb32-337"></a><span class="in">```{r}</span></span>
<span id="cb32-338"><a href="#cb32-338"></a><span class="fu">fitted</span>(ma.est, <span class="at">h=</span><span class="dv">1</span>)</span>
<span id="cb32-339"><a href="#cb32-339"></a><span class="in">```</span></span>
<span id="cb32-340"><a href="#cb32-340"></a></span>
<span id="cb32-341"><a href="#cb32-341"></a>MA models exhibit strong mean reversion and so forecasts rapidly converge to the mean of the process. This makes sense given that the process is considered to be a function of white noise.</span>
<span id="cb32-342"><a href="#cb32-342"></a></span>
<span id="cb32-345"><a href="#cb32-345"></a><span class="in">```{r}</span></span>
<span id="cb32-346"><a href="#cb32-346"></a><span class="fu">plot</span>(<span class="fu">c</span>(df<span class="sc">$</span>Banking.orders..<span class="fl">2.</span>,<span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">12</span>)), <span class="at">type =</span> <span class="st">'l'</span>)</span>
<span id="cb32-347"><a href="#cb32-347"></a><span class="fu">lines</span>(<span class="fu">c</span>(<span class="fu">fitted</span>(ma.est, <span class="at">h=</span><span class="dv">1</span>),<span class="fu">predict</span>(ma.est, <span class="at">n.ahead =</span> <span class="dv">12</span>)<span class="sc">$</span>pred)</span>
<span id="cb32-348"><a href="#cb32-348"></a>      , <span class="at">col =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="dv">5</span>) <span class="do">## use the forecast package</span></span>
<span id="cb32-349"><a href="#cb32-349"></a><span class="fu">lines</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="cn">NA</span>,<span class="dv">11</span>),res)</span>
<span id="cb32-350"><a href="#cb32-350"></a>      , <span class="at">col =</span> <span class="dv">4</span>, <span class="at">lwd =</span> <span class="dv">2</span>) <span class="do">## by hand</span></span>
<span id="cb32-351"><a href="#cb32-351"></a></span>
<span id="cb32-352"><a href="#cb32-352"></a><span class="in">```</span></span>
<span id="cb32-353"><a href="#cb32-353"></a></span>
<span id="cb32-354"><a href="#cb32-354"></a>If you forecast beyond the range of the model established by its order, the forecast will necessarily be the mean of the process by definition of the process. Consider an MA(1) model: $yt = μ + θ1 × et -1 + et$ To predict one time step in the future, our estimate for $y_{t+1} = μ + θ1 × yt + et$.</span>
<span id="cb32-355"><a href="#cb32-355"></a></span>
<span id="cb32-356"><a href="#cb32-356"></a>If we want to predict two time steps in the future, our estimate is: $E(y_{t+2} =μ+e_{t+2} +θ_1 ×e_{t+1})=μ+0+θ_1 ×0=μ$</span>
<span id="cb32-357"><a href="#cb32-357"></a></span>
<span id="cb32-358"><a href="#cb32-358"></a>With an MA(1) process we cannot offer an informed prediction beyond one step ahead, and for an MA(q) process in general we cannot offer a more informed predic‐ tion beyond q steps than the mean value emitted by the process. By informed predic‐ tion, I mean one in which our most recent measurements have an impact on the forecast.</span>
<span id="cb32-359"><a href="#cb32-359"></a></span>
<span id="cb32-360"><a href="#cb32-360"></a>We can see this by producing predictions with our MA(9) model that we just fit, and for which we now seek predictions 10 time steps ahead.</span>
<span id="cb32-361"><a href="#cb32-361"></a></span>
<span id="cb32-362"><a href="#cb32-362"></a>When we attempt to predict 10 time steps into the future, we predict the mean for every time step</span>
<span id="cb32-363"><a href="#cb32-363"></a></span>
<span id="cb32-366"><a href="#cb32-366"></a><span class="in">```{r}</span></span>
<span id="cb32-367"><a href="#cb32-367"></a><span class="fu">fitted</span>(ma.est, <span class="at">h=</span><span class="dv">10</span>)[<span class="dv">40</span><span class="sc">:</span><span class="dv">50</span>]</span>
<span id="cb32-368"><a href="#cb32-368"></a><span class="fu">fitted</span>(ma.est, <span class="at">h=</span><span class="dv">9</span>)[<span class="dv">40</span><span class="sc">:</span><span class="dv">50</span>]</span>
<span id="cb32-369"><a href="#cb32-369"></a><span class="in">```</span></span>
<span id="cb32-370"><a href="#cb32-370"></a></span>
<span id="cb32-371"><a href="#cb32-371"></a><span class="fu">## more complicated case</span></span>
<span id="cb32-372"><a href="#cb32-372"></a></span>
<span id="cb32-375"><a href="#cb32-375"></a><span class="in">```{r}</span></span>
<span id="cb32-376"><a href="#cb32-376"></a><span class="fu">class</span>(AirPassengers)</span>
<span id="cb32-377"><a href="#cb32-377"></a><span class="co">#This is the start of the time series</span></span>
<span id="cb32-378"><a href="#cb32-378"></a><span class="fu">start</span>(AirPassengers)</span>
<span id="cb32-379"><a href="#cb32-379"></a><span class="co">#This is the end of the time series</span></span>
<span id="cb32-380"><a href="#cb32-380"></a><span class="fu">end</span>(AirPassengers)</span>
<span id="cb32-381"><a href="#cb32-381"></a><span class="co">#The cycle of this time series is 12months in a year</span></span>
<span id="cb32-382"><a href="#cb32-382"></a><span class="fu">frequency</span>(AirPassengers)</span>
<span id="cb32-383"><a href="#cb32-383"></a><span class="fu">summary</span>(AirPassengers)</span>
<span id="cb32-384"><a href="#cb32-384"></a><span class="in">```</span></span>
<span id="cb32-385"><a href="#cb32-385"></a></span>
<span id="cb32-388"><a href="#cb32-388"></a><span class="in">```{r}</span></span>
<span id="cb32-389"><a href="#cb32-389"></a><span class="co">#The number of passengers are distributed across the spectrum</span></span>
<span id="cb32-390"><a href="#cb32-390"></a><span class="fu">plot</span>(AirPassengers)</span>
<span id="cb32-391"><a href="#cb32-391"></a><span class="co">#This will plot the time series</span></span>
<span id="cb32-392"><a href="#cb32-392"></a><span class="fu">abline</span>(<span class="at">reg=</span><span class="fu">lm</span>(AirPassengers<span class="sc">~</span><span class="fu">time</span>(AirPassengers)))</span>
<span id="cb32-393"><a href="#cb32-393"></a><span class="co"># This will fit in a line</span></span>
<span id="cb32-394"><a href="#cb32-394"></a><span class="in">```</span></span>
<span id="cb32-395"><a href="#cb32-395"></a></span>
<span id="cb32-398"><a href="#cb32-398"></a><span class="in">```{r}</span></span>
<span id="cb32-399"><a href="#cb32-399"></a><span class="fu">cycle</span>(AirPassengers)</span>
<span id="cb32-400"><a href="#cb32-400"></a></span>
<span id="cb32-401"><a href="#cb32-401"></a><span class="co">#This will print the cycle across years.</span></span>
<span id="cb32-402"><a href="#cb32-402"></a></span>
<span id="cb32-403"><a href="#cb32-403"></a><span class="fu">plot</span>(<span class="fu">aggregate</span>(AirPassengers,<span class="at">FUN=</span>mean))</span>
<span id="cb32-404"><a href="#cb32-404"></a><span class="co">#This will aggregate the cycles and display a year on year trend</span></span>
<span id="cb32-405"><a href="#cb32-405"></a></span>
<span id="cb32-406"><a href="#cb32-406"></a><span class="fu">boxplot</span>(AirPassengers<span class="sc">~</span><span class="fu">cycle</span>(AirPassengers))</span>
<span id="cb32-407"><a href="#cb32-407"></a><span class="co">#Box plot across months will give us a sense on seasonal effect</span></span>
<span id="cb32-408"><a href="#cb32-408"></a></span>
<span id="cb32-409"><a href="#cb32-409"></a><span class="in">```</span></span>
<span id="cb32-410"><a href="#cb32-410"></a></span>
<span id="cb32-411"><a href="#cb32-411"></a><span class="fu">### Important Inferences</span></span>
<span id="cb32-412"><a href="#cb32-412"></a></span>
<span id="cb32-413"><a href="#cb32-413"></a><span class="ss">1.  </span>The year on year trend clearly shows that the #passengers have been increasing without fail.</span>
<span id="cb32-414"><a href="#cb32-414"></a></span>
<span id="cb32-415"><a href="#cb32-415"></a><span class="ss">2.  </span>The variance and the mean value in July and August is much higher than rest of the months.</span>
<span id="cb32-416"><a href="#cb32-416"></a></span>
<span id="cb32-417"><a href="#cb32-417"></a><span class="ss">3.  </span>Even though the mean value of each month is quite different their variance is small. Hence, we have strong seasonal effect with a cycle of 12 months or less.</span>
<span id="cb32-418"><a href="#cb32-418"></a></span>
<span id="cb32-419"><a href="#cb32-419"></a>Exploring data becomes most important in a time series model -- without this exploration, you will not know whether a series is stationary or not. As in this case we already know many details about the kind of model we are looking out for.</span>
<span id="cb32-420"><a href="#cb32-420"></a></span>
<span id="cb32-421"><a href="#cb32-421"></a><span class="fu">### Solving unstationary issues</span></span>
<span id="cb32-422"><a href="#cb32-422"></a></span>
<span id="cb32-423"><a href="#cb32-423"></a>We know that we need to address two issues before we test stationary series. One, we need to remove unequal variances. We do this using log of the series. Two, we need to address the trend component. We do this by taking difference of the series. Now, let's test the resultant series.</span>
<span id="cb32-424"><a href="#cb32-424"></a></span>
<span id="cb32-427"><a href="#cb32-427"></a><span class="in">```{r}</span></span>
<span id="cb32-428"><a href="#cb32-428"></a>tseries<span class="sc">::</span><span class="fu">adf.test</span>(<span class="fu">diff</span>(<span class="fu">log</span>(AirPassengers)), <span class="at">alternative=</span><span class="st">"stationary"</span>, <span class="at">k=</span><span class="dv">0</span>)</span>
<span id="cb32-429"><a href="#cb32-429"></a></span>
<span id="cb32-430"><a href="#cb32-430"></a><span class="fu">log</span>(AirPassengers)</span>
<span id="cb32-431"><a href="#cb32-431"></a><span class="in">```</span></span>
<span id="cb32-432"><a href="#cb32-432"></a></span>
<span id="cb32-433"><a href="#cb32-433"></a>We see that the series is stationary enough to do any kind of time series modelling.</span>
<span id="cb32-434"><a href="#cb32-434"></a></span>
<span id="cb32-435"><a href="#cb32-435"></a>Next step is to find the right parameters to be used in the ARIMA model. We already know that the 'd' component is 1 as we need 1 difference to make the series stationary. We do this using the Correlation plots. Following are the ACF plots for the series:</span>
<span id="cb32-436"><a href="#cb32-436"></a></span>
<span id="cb32-439"><a href="#cb32-439"></a><span class="in">```{R}</span></span>
<span id="cb32-440"><a href="#cb32-440"></a><span class="fu">acf</span>(<span class="fu">diff</span>(<span class="fu">log</span>(AirPassengers)))</span>
<span id="cb32-441"><a href="#cb32-441"></a></span>
<span id="cb32-442"><a href="#cb32-442"></a></span>
<span id="cb32-443"><a href="#cb32-443"></a><span class="fu">pacf</span>(<span class="fu">diff</span>(<span class="fu">log</span>(AirPassengers)))</span>
<span id="cb32-444"><a href="#cb32-444"></a><span class="in">```</span></span>
<span id="cb32-445"><a href="#cb32-445"></a></span>
<span id="cb32-446"><a href="#cb32-446"></a>Clearly, ACF plot cuts off after the first lag. Hence, we understood&nbsp;that value of p should be 0 as the ACF is the curve getting a cut off. While value of q should be 1 or 2. After a few iterations, we found that (0,1,1) as (p,d,q) comes out to be the combination with least AIC and BIC.</span>
<span id="cb32-447"><a href="#cb32-447"></a></span>
<span id="cb32-450"><a href="#cb32-450"></a><span class="in">```{r}</span></span>
<span id="cb32-451"><a href="#cb32-451"></a>(fit <span class="ot">&lt;-</span> <span class="fu">arima</span>(<span class="fu">log</span>(AirPassengers), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>),<span class="at">seasonal =</span> <span class="fu">list</span>(<span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">period =</span> <span class="dv">12</span>)))</span>
<span id="cb32-452"><a href="#cb32-452"></a><span class="in">```</span></span>
<span id="cb32-453"><a href="#cb32-453"></a></span>
<span id="cb32-454"><a href="#cb32-454"></a>Let's fit an ARIMA model and predict the future 10 years. Also, we will try fitting in a seasonal component in the ARIMA formulation. Then, we will visualize the prediction along with the training data. You can use the following code to do the same :</span>
<span id="cb32-455"><a href="#cb32-455"></a></span>
<span id="cb32-458"><a href="#cb32-458"></a><span class="in">```{r}</span></span>
<span id="cb32-459"><a href="#cb32-459"></a>(fit <span class="ot">&lt;-</span> <span class="fu">arima</span>(<span class="fu">log</span>(AirPassengers), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>),<span class="at">seasonal =</span> <span class="fu">list</span>(<span class="at">order =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">period =</span> <span class="dv">12</span>)))</span>
<span id="cb32-460"><a href="#cb32-460"></a></span>
<span id="cb32-461"><a href="#cb32-461"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">n.ahead =</span> <span class="dv">10</span><span class="sc">*</span><span class="dv">12</span>)</span>
<span id="cb32-462"><a href="#cb32-462"></a></span>
<span id="cb32-463"><a href="#cb32-463"></a><span class="fu">ts.plot</span>(AirPassengers,<span class="fl">2.718</span><span class="sc">^</span>pred<span class="sc">$</span>pred, <span class="at">log =</span> <span class="st">"y"</span>, <span class="at">lty =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))</span>
<span id="cb32-464"><a href="#cb32-464"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>